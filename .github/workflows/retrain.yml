name: Retrain Model and Deploy

on:
  push:
    branches:
      - main  # âœ… Runs automatically on push to main branch
  schedule:
    - cron: "0 2 * * *"  # âœ… Runs every day at 2 AM UTC
  workflow_dispatch:  # âœ… Allows manual trigger from GitHub Actions

jobs:
  retrain:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ“¦ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ðŸ“Œ Install Dependencies
        run: pip install -r requirements.txt

      - name: ðŸ”„ Retrain Model
        env:
          DB_URL: ${{ secrets.DB_URL }}  # âœ… PostgreSQL connection
        run: python retrain_model.py  # âœ… Runs your model retraining script

      - name: ðŸ’¾ Save Model
        run: |
          mkdir -p models
          mv churn_model.pkl models/

      - name: ðŸ“¤ Commit & Push Updated Model
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add models/churn_model.pkl
          git commit -m "ðŸ”„ Auto-retrained model update"
          git push origin main

  deploy:
    needs: retrain
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”‘ Deploy to Render
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
          -H "Accept: application/json" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Content-Type: application/json" \
          --data '{"clearCache": false}'

